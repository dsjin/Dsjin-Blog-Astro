---
const { disqusHost } = Astro.props
---

<div id="disqus_thread" style="min-height: 200px"></div>

<script is:inline define:vars={{disqusHost}}>
  if (!window.DisqusWidget) {
    window.DisqusWidget = {
      overwriteGlobalSelectors: function () {
        window.$disqus = document.querySelector("#disqus_thread")
      },
      init: function () {
        this.overwriteGlobalSelectors()
        this.initDisqus()
      },
      handleObserver: function (entries, $context) {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            $context.observer.disconnect()
            $context.init()
          }
        })
      },
      observerDisqus: function () {
        if ('IntersectionObserver' in window) {
          this.observer = new IntersectionObserver((entries) => this.handleObserver(entries, this), {
            root: null,
            rootMargin: '300px',
            threshold: 0.5
          })
          return this.observer.observe(document.querySelector("#disqus_thread"))
        }
        this.init()
      },
      initDisqus: () => {
        // early escape if $disqus not exists
        if (window.$disqus === null) {
          return
        }

        // Reset DISQUS, Rather than loading new embed.js
        if (window.DISQUS) {
          window.DISQUS.reset({
            reload: true,
          })
          return
        }

        document.disqus_config = () => {
          this.page.url = document.baseURI
          this.page.identifier = window.location.pathname
        }

        (function () {
          // DON'T EDIT BELOW THIS LINE
          const d = document,
            s = d.createElement("script")
          s.src = `${disqusHost}/embed.js`
          s.setAttribute("data-timestamp", String(+new Date()));
          (d.head || d.body).appendChild(s)
        })()
      },
    }

    window.DisqusWidget.observerDisqus()
  }
</script>
<noscript
  >Please enable JavaScript to view the <a
    href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a
  ></noscript
>
