---
import type { Post } from '../assets/types/posts'
import ArticleList from '../components/ArticleList.vue'
import { getCollection, type CollectionEntry } from 'astro:content';

const { tag, page, direction } = Astro.props

const start = (parseInt(page)-1) * 5
const end = start + 5

let targetPosts = []

if (tag) {
	targetPosts = (await getCollection('blog', ({ data }: CollectionEntry<'blog'>) => {
		let included = false
		data.tags.forEach((value: string) => {
			if (value.toLowerCase().replace(/ /g, '-') === tag) {
				included = true
			}
		})
		return included
	}))
} else {
	targetPosts = await getCollection('blog')
}

targetPosts = targetPosts.map((value): Post => {
	return {
		...value.data,
		slug: value.slug,
		coverImage: value.data.coverImage?.src,
		author: {
			...value.data.author,
			profileImage: value.data.author.profileImage?.src
		}
	}
}).sort((a: Post, b: Post) => {
	if (direction === 'DESC') {
		return new Date(b.createdDate).getTime() - new Date(a.createdDate).getTime()
	} else {
		return new Date(a.createdDate).getTime() - new Date(b.createdDate).getTime()
	}
}).slice(start, end)

---

{
  targetPosts.map((post: Post) => <ArticleList info={post} />)
}
